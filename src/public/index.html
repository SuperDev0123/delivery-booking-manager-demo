<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Deliver Me</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
</head>

<body>
    <div id="app"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/dropzone.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script>
		var filename = "";

		Dropzone.options.uploadDropzone = {
			paramName: "file", 	// The name that will be used to transfer the file,
			maxFilesize: 250, 	// MB
			autoProcessQueue: false,
			withCredentials: true,
			url: "http://localhost:8000/api/share/upload/",
			headers: {
	            'Authorization': "JWT ",
	            'Content-Type': 'multipart/form-data; charset=UTF-8',
	            'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept, Authorization',
	            'Access-Control-Allow-Origin': '*'
        	},
			accept: function(file, done) {
				console.log(file.name);
				filename = file.name;
				done();
			},
			init: function() {
				var myDropzone = this,
        		submitButton = document.querySelector("#submit-upload");

        		submitButton.addEventListener('click', function(e) {
        			var isValid = document.querySelector('#warehouse').reportValidity();
			        e.preventDefault();
			        e.stopPropagation();
			        if (isValid)
			        	myDropzone.processQueue();
			    });

			    this.on('sending', function(data, xhr, formData) {
			    	formData.append("warehouse_id", jQuery("#warehouse option:selected").val());
			    });

				this.on("success", function(file) { 
					var myInterval = setInterval(myTimer, 2000);

					function myTimer() {
					    $.ajax({
						  url: "/share/upload/status/",
						  data: {filename: filename}
						}).done(function(res) {
						  if (res.status_code === 0) {
						  	$("p#upload-status").text("Checking file(" + file.xhr.response + ")");
						  } else if (res.status_code === 1) {
						  	$("p#upload-status").text("Successfully uploaded!");
						  } else if (res.status_code === 2) {
						  	let errors = res.errors;
						  	$("p#upload-status").text("There are some error(s) while uploading. Please fix out and upload again.");

						  	for (let i = 0; i < errors.length; i++)
						  		$("p#upload-status").append("<p>" + errors[i] + "</p>");
						  }

						  if (res.status_code !== 0)
						  	myStopFunction();
						});
					}

					function myStopFunction() {
					    clearInterval(myInterval);
					} 

					$("p#upload-filename").text("Upload a file with prepend filename: " + file.xhr.response);
				});
			}
		};
	</script>
</body>

</html>